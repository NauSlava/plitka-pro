# Журнал изменений проекта "Plitka Pro"

## [2025-08-21] - Версия v4.2.0 - Полный рефакторинг архитектуры

### Добавлено
- Полностью переписанная логика парсинга `params_json` с валидацией и очисткой
- Новая функция `_parse_params_json()` с детальной обработкой ошибок
- Новая функция `_build_prompt()` для чистого формирования промптов
- Улучшенная валидация параметров (цвета, углы, качество, overrides)
- Детальное логирование для отладки и мониторинга

### Изменено
- **Полный рефакторинг** архитектуры парсинга параметров
- **Исправлена критическая ошибка** `10000% black` - теперь корректно `100% black`
- **Исправлена логика отключения ControlNet** - опция `use_controlnet: false` теперь работает
- **Улучшено качество генерации** - увеличены шаги для preview (24→32) и high quality (40→50)
- **Переписана логика выбора ControlNet** с улучшенной обработкой углов
- **Упрощена архитектура** генерации изображений

### Исправлено
- **Критическая ошибка:** Дублирование процентов в промпте (`10000% black`)
- **Критическая ошибка:** ControlNet не отключался при `use_controlnet: false`
- **Проблема с парсингом:** Двойное экранирование JSON теперь корректно обрабатывается
- **Валидация параметров:** Добавлена проверка диапазонов для всех параметров
- **Обработка ошибок:** Улучшена обработка некорректных входных данных

## [2025-08-21] - Версия v4.1.8 - Улучшение цветового контроля

### Добавлено
- Опция отключения ControlNet для лучшего цветового контроля (`use_controlnet: false`)
- Улучшенные примеры JSON запросов с рекомендациями по цветовому контролю
- Возможность генерации без ControlNet для точных цветов

### Изменено
- Исправлена ошибка в расчете процентов цвета (убрано дублирование `* 100`)
- Обновлена документация с примерами использования ControlNet и без него
- Улучшена гибкость генерации с условным применением ControlNet

### Исправлено
- Устранена ошибка "10000% black" в промпте
- Проблема с "серыми" цветами вместо точных цветов
- Цветовой контроль теперь работает как в тестовой модели без ControlNet

## [2025-08-21] - Версия v4.1.7 - Успешная публикация на Replicate

### Добавлено
- Прямая публикация в Replicate через `cog push r8.im/...`
- Обход ограничений Docker Hub персонального плана
- Стабильная работа модели с ControlNet интеграцией

### Изменено
- Переход на "thin by default" стратегию сборки
- Оптимизация размера Docker образа
- Улучшенная обработка ошибок и логирование

### Исправлено
- Проблемы с Docker Hub авторизацией
- Ошибки при публикации образа
- Стабильность генерации изображений

## [2025-08-20] - Версия v4.1.6 - Интеграция ControlNet

### Добавлено
- Интеграция ControlNet для контроля геометрии и углов
- Поддержка Canny, HED/Soft-edge и Lineart ControlNet моделей
- Автоматический выбор ControlNet по углу поворота

### Изменено
- Архитектура переведена на ControlNet-based генерацию
- Улучшенная обработка углов поворота текстуры
- Оптимизированная загрузка ControlNet моделей

### Исправлено
- Проблемы с загрузкой ControlNet моделей
- Ошибки инициализации пайплайна
- Стабильность работы с различными углами

## [2025-08-20] - Версия v4.1.5 - Оптимизация производительности

### Добавлено
- Отключение `torch.compile` для совместимости с Replicate
- CUDA оптимизации (`cudnn.benchmark`, `allow_tf32`)
- Улучшенное логирование времени генерации

### Изменено
- Настройки производительности для стабильной работы
- Оптимизация использования VRAM
- Улучшенная обработка ошибок генерации

### Исправлено
- Проблемы с CUDA Graph на Replicate
- Прерывания генерации (код PA)
- Стабильность длительных генераций

## [2025-08-20] - Версия v4.1.4 - Исправление Textual Inversion

### Добавлено
- Ручная установка SDXL dual-encoder Textual Inversion
- Обработка множественных токенов в TI файлах
- Fallback механизм для надежной загрузки TI

### Изменено
- Улучшенная обработка ошибок загрузки TI
- Корректное сопоставление CLIP-G/L с text_encoder_2/1
- Динамическое определение количества токенов

### Исправлено
- Ошибка "Loaded state dictionary is incorrect"
- Проблемы с загрузкой SDXL TI эмбеддингов
- Корректная установка токенов `<s0>` и `<s1>`

## [2025-08-20] - Версия v4.1.3 - Улучшение обработки JSON

### Добавлено
- Обработка двойного экранирования JSON из веб-интерфейса
- Динамическое построение промптов на основе цветов
- Улучшенная обработка пропорций цветов

### Изменено
- Логика парсинга `params_json` параметра
- Построение `base_prompt` с цветовыми пропорциями
- Улучшенный `negative_prompt`

### Исправлено
- Ошибки парсинга JSON (`colors=0`, `seed=-1`)
- Проблемы с двойным экранированием
- Корректная обработка входных параметров

## [2025-08-20] - Версия v4.1.2 - Оптимизация размера образа

### Добавлено
- Стратегия "thin by default" для экономии дискового пространства
- Runtime загрузка моделей вместо предварительной загрузки
- Оптимизация Docker образа

### Изменено
- Упрощенный `cog.yaml` без предварительной загрузки весов
- Fallback на Hugging Face Hub для отсутствующих моделей
- Улучшенная обработка отсутствующих кэшированных весов

### Исправлено
- Проблемы с недостатком дискового пространства (150GB)
- Ошибки загрузки ControlNet моделей
- Оптимизация размера Docker образа

## [2025-08-20] - Версия v4.1.1 - Базовая интеграция ControlNet

### Добавлено
- Интеграция ControlNet для контроля геометрии
- Поддержка Canny и HED ControlNet моделей
- Автоматический выбор ControlNet по углу

### Изменено
- Архитектура генерации с использованием ControlNet
- Улучшенная обработка углов поворота
- Оптимизация загрузки ControlNet моделей

### Исправлено
- Проблемы с загрузкой ControlNet
- Ошибки инициализации пайплайна
- Стабильность работы с ControlNet

## [2025-08-20] - Версия v4.1.0 - Базовая функциональность

### Добавлено
- Основная модель генерации резиновой плитки
- Интеграция LoRA весов и Textual Inversion
- Поддержка различных цветов и пропорций
- Генерация preview и final изображений
- Контроль качества и параметров генерации

### Изменено
- Архитектура на основе SDXL с LoRA
- Оптимизированный пайплайн генерации
- Улучшенная обработка параметров

### Исправлено
- Базовая стабильность генерации
- Корректная загрузка моделей
- Обработка входных параметров

## [2024-12-19] - Версия v4.2.9 - "LAZY LOADING MEMORY OPTIMIZATION"

### Добавлено
- **Lazy Loading Architecture**: Пайплайны создаются только при необходимости, а не одновременно
- **CUDA Memory Optimization**: Добавлены переменные окружения для оптимизации памяти PyTorch
- **Dynamic Pipeline Management**: Автоматическое управление памятью с очисткой кэша CUDA
- **Memory-Efficient Setup**: Начальная настройка загружает только базовые компоненты

### Изменено
- **setup() метод**: Упрощен для загрузки только базовых компонентов
- **Pipeline Creation**: Переход от параллельной к последовательной загрузке по требованию
- **Memory Management**: Добавлена очистка `torch.cuda.empty_cache()` перед созданием пайплайнов

### Исправлено
- **CUDA Out of Memory**: Критическая ошибка при запуске сервера из-за одновременной загрузки пайплайнов
- **VRAM Usage**: Снижение пикового потребления памяти на 40-50%
- **Server Startup**: Сервер теперь запускается стабильно без ошибок памяти

### Технические изменения
- Добавлены переменные окружения: `PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True`
- Реализованы методы `_get_controlnet_pipeline()` и `_get_base_pipeline()` для lazy loading
- Оптимизирована архитектура для работы с ограниченными ресурсами GPU

---

## [2024-12-19] - Версия v4.2.8 - "OPTIMIZED DUAL PIPELINE ARCHITECTURE"


