# üö® –û–¢–ß–ï–¢ –û–ë –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø–• v4.3.41 "TI DUAL-ENCODER FIX & CACHE FIX"

## üìä –°—Ç–∞—Ç—É—Å

*–í–µ—Ä—Å–∏—è: v4.3.41 "TI DUAL-ENCODER FIX & CACHE FIX"*  
*–°—Ç–∞—Ç—É—Å: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã, –º–æ–¥–µ–ª—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞*  
*–î–∞—Ç–∞: 25 –¥–µ–∫–∞–±—Ä—è 2024*

---

## üéØ –ê–Ω–∞–ª–∏–∑ –ü—Ä–æ–±–ª–µ–º v4.3.40

### **‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. **Textual Inversion –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è**:
   ```
   ERROR: Loaded state dictionary is incorrect: {'clip_g': ..., 'clip_l': ...}
   ```
   - SDXL dual-encoder —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
   - –ù–∞—à —Ñ–∞–π–ª –∏–º–µ–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É `clip_g` –∏ `clip_l`
   - –û–∂–∏–¥–∞–µ—Ç—Å—è `string_to_param` –∏–ª–∏ single key

2. **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –∫—ç—à–∞**:
   ```
   The cache for model files in Transformers v4.22.0 has been updated. 
   Migrating your old cache. This is a one-time only operation.
   ```
   - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–µ–π –∫—ç—à–∞
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏

3. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏**:
   - –ü—Ä–∏ –æ—à–∏–±–∫–µ TI –º–æ–¥–µ–ª—å –ø–∞–¥–∞–µ—Ç
   - –ù–µ—Ç fallback –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤

---

## üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### **‚úÖ 1. Textual Inversion dual-encoder (4 –º–µ—Ç–æ–¥–∞ —Å fallback)**

**–ú–µ—Ç–æ–¥ 1**: SDXL dual-encoder —Ñ–æ—Ä–º–∞—Ç
```python
self.pipe.load_textual_inversion(
    ti_path, 
    token="TOK",
    weight_name="learned_embeds.safetensors"
)
```

**–ú–µ—Ç–æ–¥ 2**: –° trigger_token
```python
self.pipe.load_textual_inversion(
    ti_path,
    token="TOK",
    weight_name="learned_embeds.safetensors",
    trigger_token="TOK"
)
```

**–ú–µ—Ç–æ–¥ 3**: –ë–∞–∑–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
```python
self.pipe.load_textual_inversion(ti_path, token="TOK")
```

**–ú–µ—Ç–æ–¥ 4**: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞
```python
# –ó–∞–≥—Ä—É–∂–∞–µ–º embeddings –≤—Ä—É—á–Ω—É—é
embeddings = torch.load(ti_path, map_location="cpu")
if "clip_g" in embeddings and "clip_l" in embeddings:
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º dual-encoder —Ñ–æ—Ä–º–∞—Ç –≤ single —Ñ–æ—Ä–º–∞—Ç
    combined_embeddings = torch.cat([embeddings["clip_g"], embeddings["clip_l"]], dim=0)
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ single —Ñ–æ—Ä–º–∞—Ç
    temp_path = "/tmp/converted_embeddings.safetensors"
    torch.save(combined_embeddings, temp_path)
    self.pipe.load_textual_inversion(temp_path, token="TOK")
```

### **‚úÖ 2. –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∫—ç—à–∞ (–ø–æ–ª–Ω–æ–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ)**

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∫—ç—à–∞**:
```python
os.environ["HF_DATASETS_CACHE"] = "/tmp/hf_datasets_cache"
os.environ["HF_MODELS_CACHE"] = "/tmp/hf_models_cache"
```

**–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏**:
```python
os.environ["TRANSFORMERS_CACHE_MIGRATION_DISABLE"] = "1"
os.environ["HF_HUB_CACHE_MIGRATION_DISABLE"] = "1"
```

### **‚úÖ 3. Graceful degradation**

**Fallback –º–µ—Ö–∞–Ω–∏–∑–º**:
```python
except Exception as e4:
    logger.error(f"‚ùå –í—Å–µ –º–µ—Ç–æ–¥—ã –Ω–µ —É–¥–∞–ª–∏—Å—å. –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: {e4}")
    logger.warning("‚ö†Ô∏è Continuing without Textual Inversion - using base model")
    return False
```

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### **‚úÖ Textual Inversion:**
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –æ–¥–Ω–∏–º –∏–∑ 4 –º–µ—Ç–æ–¥–æ–≤ –±–µ–∑ –æ—à–∏–±–æ–∫ `state_dict`
- –õ–æ–≥: `‚úÖ OUR TRAINED Textual Inversion loaded successfully with [method]`
- Fallback –Ω–∞ –±–∞–∑–æ–≤—É—é –º–æ–¥–µ–ª—å –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

### **‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∫—ç—à–∞:**
- –ü–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∫—ç—à–∞ –≤ `/tmp/`
- –û—Ç–∫–ª—é—á–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

### **‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:**
- Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö TI
- –ú–æ–¥–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –±–µ–∑ Textual Inversion
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ä–∞–±–æ—á–∞—è –ª–æ–≥–∏–∫–∞ colormap

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:**
1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫**: `Loaded state dictionary is incorrect`
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π**: –ú–∏–≥—Ä–∞—Ü–∏—è –∫—ç—à–∞
3. **–£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ TI**: –û–¥–∏–Ω –∏–∑ 4 –º–µ—Ç–æ–¥–æ–≤
4. **–°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞**: Fallback –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

### **–¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
- 8 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ –∞—Å–ø–µ–∫—Ç—ã
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Ç–æ–¥–∞ –∑–∞–≥—Ä—É–∑–∫–∏ TI
- –í–∞–ª–∏–¥–∞—Ü–∏—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ fallback –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤

---

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### **–°—Ç–∞—Ç—É—Å:**
- ‚úÖ –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω
- ‚úÖ –ú–æ–¥–µ–ª—å —Å–æ–±—Ä–∞–Ω–∞: `cog build`
- ‚úÖ –ú–æ–¥–µ–ª—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞: `cog push`
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã

### **–°—Å—ã–ª–∫–∞:**
https://replicate.com/nauslava/plitka-pro-project:v4.3.41

---

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ Replicate API
2. **–í–∞–ª–∏–¥–∞—Ü–∏—è**: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ TI –±–µ–∑ –æ—à–∏–±–æ–∫
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –∫—ç—à–∞
4. **–ê–Ω–∞–ª–∏–∑**: –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

---

*–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è –≤–µ—Ä—Å–∏–∏ v4.3.41 "TI DUAL-ENCODER FIX & CACHE FIX"*  
*–î–∞—Ç–∞: 25 –¥–µ–∫–∞–±—Ä—è 2024*  
*–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é*
